---
import { getRelativeLocaleUrl } from 'astro:i18n';

const currentLocale = Astro.currentLocale || 'en';
const isEnglish = currentLocale === 'en';
const switchLocale = isEnglish ? 'fr' : 'en';
const switchLabel = isEnglish ? 'FR' : 'EN';

// Get the current page path without locale
const currentPath = Astro.url.pathname.replace(/^\/fr\/?/, '/');
const targetPath = currentPath === '/' ? '' : currentPath;
const switchUrl = getRelativeLocaleUrl(switchLocale, targetPath);
---

<div class="language-switcher" data-language-switcher-root>
  <a
    href={switchUrl}
    aria-label={`Switch to ${switchLabel === 'FR' ? 'French' : 'English'}`}
    data-locale={switchLocale}
  >
    {switchLabel}
  </a>
</div>

<script is:inline>
  const script = document.currentScript;
  const container = script?.previousElementSibling;
  const link = container?.querySelector('a');
  const storageKey = 'preferred-locale';

  const getStoredLocale = () => {
    try {
      return localStorage.getItem(storageKey);
    } catch {
      return null;
    }
  };

  link?.addEventListener('click', (event) => {
    const anchor = event.currentTarget;
    const locale = anchor?.dataset?.locale;
    if (!locale) return;
    try {
      localStorage.setItem(storageKey, locale);
    } catch {
      /* ignore write errors */
    }
  });

  const storedLocale = getStoredLocale();
  const currentLocale = document.documentElement.lang;

  if (storedLocale && storedLocale !== currentLocale) {
    const pathname = window.location.pathname;
    let newPath = pathname;

    if (storedLocale === 'fr') {
      if (!pathname.startsWith('/fr')) {
        newPath = '/fr' + pathname;
      }
    } else if (pathname.startsWith('/fr')) {
      newPath = pathname.replace(/^\/fr\/?/, '/') || '/';
    }

    if (newPath !== pathname) {
      window.location.pathname = newPath;
    }
  }
</script>

<style>
  .language-switcher {
    display: flex;
    margin: 0;
    padding: 0;
  }

  .language-switcher a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    min-width: 2.5rem;
    min-height: 2.5rem;
    max-width: 2.5rem;
    max-height: 2.5rem;
    padding: 0.5rem;
    margin: 0;
    border-radius: 999px;
    border: 1px solid var(--color-border-subtle);
    background: var(--color-surface);
    color: var(--color-text-secondary);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.75rem;
    line-height: 1;
    box-sizing: border-box;
    vertical-align: top;
    transition: background 0.2s ease, color 0.2s ease,
      border-color 0.2s ease, transform 0.2s ease;
    flex-shrink: 0;
  }

  .language-switcher a:hover {
    background: var(--color-surface-hover);
    border-color: var(--color-border-strong);
    color: var(--color-text-primary);
    transform: translateY(-1px);
  }

  .language-switcher a:focus-visible {
    outline: 2px solid var(--color-outline);
    outline-offset: 2px;
  }
</style>
